services:
  rabbitmq:
    image: rabbitmq:management
    container_name: rabbitmq
    restart: always
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: secretpassword
      RABBITMQ_LOGS: "-"  # Log to stdout
      RABBITMQ_LOG_LEVEL: warning
    networks:
      - coffee-net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    container_name: gateway
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      PYTHONPATH: /app
    networks:
      - coffee-net

  client:
    build:
      context: .
      dockerfile: client/Dockerfile
    container_name: client
    depends_on:
      gateway:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      DATA_DIR: /app/.data
      SERVER_ADDRESS: gateway:5000
      CLIENT_ID: client1
      BATCH_MAX_AMOUNT: 100
    volumes:
      - ./data:/app/.data
    networks:
      - coffee-net

  cleaner_transactions:
    build:
      context: .
      dockerfile: cleaner/Dockerfile
    container_name: cleaner_transactions
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: transactions_queue
      QUEUE_OUT: transactions_cleaned
      DATA_TYPE: transactions
    networks:
      - coffee-net

  cleaner_transaction_items:
    build:
      context: .
      dockerfile: cleaner/Dockerfile
    container_name: cleaner_transaction_items
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: transaction_items_queue
      QUEUE_OUT: transaction_items_cleaned
      DATA_TYPE: transaction_items
    networks:
      - coffee-net

  cleaner_users:
    build:
      context: .
      dockerfile: cleaner/Dockerfile
    container_name: cleaner_users
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: users_queue
      QUEUE_OUT: users_cleaned
      DATA_TYPE: users
    networks:
      - coffee-net

  cleaner_stores:
    build:
      context: .
      dockerfile: cleaner/Dockerfile
    container_name: cleaner_stores
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: stores_queue
      QUEUE_OUT: stores_cleaned
      DATA_TYPE: stores
    networks:
      - coffee-net

  cleaner_menu_items:
    build:
      context: .
      dockerfile: cleaner/Dockerfile
    container_name: cleaner_menu_items
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: menu_items_queue
      QUEUE_OUT: menu_items_cleaned
      DATA_TYPE: menu_items
    networks:
      - coffee-net

  joiner_q1:
    build:
      context: .
      dockerfile: joiner/Dockerfile
    container_name: joiner_q1
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: transactions_cleaned
      QUEUE_OUT: sort_q1_request
      OUTPUT_FILE: /app/output/q1_unsorted.csv
      QUERY_TYPE: q1
    volumes:
      - ./output:/app/output
    networks:
      - coffee-net

  sorter_q1:
    build:
      context: .
      dockerfile: sort/Dockerfile
    container_name: sorter_q1
    depends_on:
      rabbitmq:
        condition: service_healthy
      joiner_q1:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: sort_q1_request
      INPUT_FILE: /app/output/q1_unsorted.csv
      OUTPUT_FILE: /app/output/q1.csv
      SORT_COLUMN_INDEX: 0
    volumes:
      - ./output:/app/output
    networks:
      - coffee-net

networks:
  coffee-net:
    driver: bridge