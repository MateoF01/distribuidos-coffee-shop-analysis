services:
  rabbitmq:
    image: rabbitmq:management
    container_name: rabbitmq
    restart: always
    ports:
    - 5672:5672
    - 15672:15672
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: secretpassword
      RABBITMQ_LOGS: '-'
      RABBITMQ_LOG_LEVEL: warning
      RABBITMQ_HEARTBEAT: 300
    networks:
    - coffee-net
    healthcheck:
      test:
      - CMD
      - rabbitmq-diagnostics
      - check_port_connectivity
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    container_name: gateway
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      PYTHONPATH: /app
      GATEWAY_HOST: 0.0.0.0
      GATEWAY_PORT: 5000
      QUEUE_IN: results
      REQUESTS_PER_CLIENT: 1
      GATEWAY_MAX_PROCESSES: 3
    networks:
    - coffee-net
  client1:
    build:
      context: .
      dockerfile: client/Dockerfile
    container_name: client1
    depends_on:
      gateway:
        condition: service_started
      sender_q1:
        condition: service_started
      sender_q2_a:
        condition: service_started
      sender_q2_b:
        condition: service_started
      sender_q3:
        condition: service_started
      sender_q4:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      DATA_DIR: /app/.data
      SERVER_ADDRESS: gateway:5000
      CLIENT_ID: client1
      BATCH_MAX_AMOUNT: 5000
      REQUESTS_PER_CLIENT: 1
    volumes:
    - ./data:/app/.data
    - ./client/results:/app/client/results
    networks:
    - coffee-net
  client2:
    build:
      context: .
      dockerfile: client/Dockerfile
    container_name: client2
    depends_on:
      gateway:
        condition: service_started
      sender_q1:
        condition: service_started
      sender_q2_a:
        condition: service_started
      sender_q2_b:
        condition: service_started
      sender_q3:
        condition: service_started
      sender_q4:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      DATA_DIR: /app/.data
      SERVER_ADDRESS: gateway:5000
      CLIENT_ID: client2
      BATCH_MAX_AMOUNT: 5000
      REQUESTS_PER_CLIENT: 1
    volumes:
    - ./data:/app/.data
    - ./client/results:/app/client/results
    networks:
    - coffee-net
  client3:
    build:
      context: .
      dockerfile: client/Dockerfile
    container_name: client3
    depends_on:
      gateway:
        condition: service_started
      sender_q1:
        condition: service_started
      sender_q2_a:
        condition: service_started
      sender_q2_b:
        condition: service_started
      sender_q3:
        condition: service_started
      sender_q4:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      DATA_DIR: /app/.data
      SERVER_ADDRESS: gateway:5000
      CLIENT_ID: client3
      BATCH_MAX_AMOUNT: 5000
      REQUESTS_PER_CLIENT: 1
    volumes:
    - ./data:/app/.data
    - ./client/results:/app/client/results
    networks:
    - coffee-net
  cleaner_transactions:
    build:
      context: .
      dockerfile: cleaner/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
      wsm_transactions:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      WSM_HOST: wsm_transactions
      WSM_PORT: 9000
      QUEUE_IN: transactions_queue
      QUEUE_OUT: transactions_cleaned
      DATA_TYPE: transactions
    networks:
    - coffee-net
  cleaner_transaction_items:
    build:
      context: .
      dockerfile: cleaner/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
      wsm_transaction_items:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      WSM_HOST: wsm_transaction_items
      WSM_PORT: 9001
      QUEUE_IN: transaction_items_queue
      QUEUE_OUT: transaction_items_cleaned
      DATA_TYPE: transaction_items
    networks:
    - coffee-net
  cleaner_users:
    build:
      context: .
      dockerfile: cleaner/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
      wsm_users:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      WSM_HOST: wsm_users
      WSM_PORT: 9002
      QUEUE_IN: users_queue
      QUEUE_OUT: users_cleaned
      DATA_TYPE: users
    networks:
    - coffee-net
  cleaner_stores:
    build:
      context: .
      dockerfile: cleaner/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
      wsm_stores:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      WSM_HOST: wsm_stores
      WSM_PORT: 9003
      QUEUE_IN: stores_queue
      QUEUE_OUT: stores_cleaned_q3,stores_cleaned_q4
      DATA_TYPE: stores
    networks:
    - coffee-net
  cleaner_menu_items:
    build:
      context: .
      dockerfile: cleaner/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
      wsm_menu_items:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      WSM_HOST: wsm_menu_items
      WSM_PORT: 9004
      QUEUE_IN: menu_items_queue
      QUEUE_OUT: menu_items_cleaned
      DATA_TYPE: menu_items
    networks:
    - coffee-net
  cleaner_transactions_q4:
    build:
      context: .
      dockerfile: cleaner/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      temporal_filter_transactions:
        condition: service_started
      wsm_transactions_q4:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      WSM_HOST: wsm_transactions_q4
      WSM_PORT: 9005
      QUEUE_IN: transactions_filtered_Q4
      QUEUE_OUT: transactions_cleaned_Q4
      DATA_TYPE: transactions_q4
    networks:
    - coffee-net
  wsm_transactions_q4:
    build:
      context: .
      dockerfile: WSM/Dockerfile
    container_name: wsm_transactions_q4
    environment:
      PYTHONUNBUFFERED: 1
      STATE_FILE_PATH: /app/output/worker_states_transactions_q4.json
      HOST: 0.0.0.0
      PORT: 9005
    volumes:
    - ./output_wsm:/app/output
    networks:
    - coffee-net
  wsm_transactions:
    build:
      context: .
      dockerfile: WSM/Dockerfile
    container_name: wsm_transactions
    environment:
      PYTHONUNBUFFERED: 1
      STATE_FILE_PATH: /app/output/worker_states_transactions.json
      HOST: 0.0.0.0
      PORT: 9000
    volumes:
    - ./output_wsm:/app/output
    networks:
    - coffee-net
  wsm_transaction_items:
    build:
      context: .
      dockerfile: WSM/Dockerfile
    container_name: wsm_transaction_items
    environment:
      PYTHONUNBUFFERED: 1
      STATE_FILE_PATH: /app/output/worker_states_transaction_items.json
      HOST: 0.0.0.0
      PORT: 9001
    volumes:
    - ./output_wsm:/app/output
    networks:
    - coffee-net
  wsm_users:
    build:
      context: .
      dockerfile: WSM/Dockerfile
    container_name: wsm_users
    environment:
      PYTHONUNBUFFERED: 1
      STATE_FILE_PATH: /app/output/worker_states_users.json
      HOST: 0.0.0.0
      PORT: 9002
    volumes:
    - ./output_wsm:/app/output
    networks:
    - coffee-net
  wsm_stores:
    build:
      context: .
      dockerfile: WSM/Dockerfile
    container_name: wsm_stores
    environment:
      PYTHONUNBUFFERED: 1
      STATE_FILE_PATH: /app/output/worker_states_stores.json
      HOST: 0.0.0.0
      PORT: 9003
    volumes:
    - ./output_wsm:/app/output
    networks:
    - coffee-net
  wsm_menu_items:
    build:
      context: .
      dockerfile: WSM/Dockerfile
    container_name: wsm_menu_items
    environment:
      PYTHONUNBUFFERED: 1
      STATE_FILE_PATH: /app/output/worker_states_menu_items.json
      HOST: 0.0.0.0
      PORT: 9004
    volumes:
    - ./output_wsm:/app/output
    networks:
    - coffee-net
  temporal_filter_transactions:
    build:
      context: .
      dockerfile: filter/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
      wsm_temporal_filter_transactions:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: transactions_cleaned
      QUEUE_OUT: transactions_filtered_Q1,transactions_filtered_Q3, transactions_filtered_Q4
      DATA_TYPE: transactions
      FILTER_TYPE: temporal
      WSM_HOST: wsm_temporal_filter_transactions
      WSM_PORT: 9009
    networks:
    - coffee-net
  wsm_temporal_filter_transactions:
    build:
      context: .
      dockerfile: WSM/Dockerfile
    container_name: wsm_temporal_filter_transactions
    environment:
      PYTHONUNBUFFERED: 1
      STATE_FILE_PATH: /app/output/worker_states_temporal_filter_transactions.json
      HOST: 0.0.0.0
      PORT: 9009
    volumes:
    - ./output_wsm:/app/output
    networks:
    - coffee-net
  temporal_filter_transaction_items:
    build:
      context: .
      dockerfile: filter/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
      wsm_temporal_filter_transaction_items:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: transaction_items_cleaned
      QUEUE_OUT: transaction_items_filtered_Q2
      DATA_TYPE: transaction_items
      FILTER_TYPE: temporal
      WSM_HOST: wsm_temporal_filter_transaction_items
      WSM_PORT: 9010
    networks:
    - coffee-net
  wsm_temporal_filter_transaction_items:
    build:
      context: .
      dockerfile: WSM/Dockerfile
    container_name: wsm_temporal_filter_transaction_items
    environment:
      PYTHONUNBUFFERED: 1
      STATE_FILE_PATH: /app/output/worker_states_temporal_filter_transaction_items.json
      HOST: 0.0.0.0
      PORT: 9010
    volumes:
    - ./output_wsm:/app/output
    networks:
    - coffee-net
  amount_filter_transactions:
    build:
      context: .
      dockerfile: filter/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
      wsm_amount_filter_transactions:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: transactions_filtered_Q1
      QUEUE_OUT: transactions_filtered_Q1_b
      DATA_TYPE: transactions
      FILTER_TYPE: amount
      MIN_AMOUNT: 75
      WSM_HOST: wsm_amount_filter_transactions
      WSM_PORT: 9011
    networks:
    - coffee-net
  wsm_amount_filter_transactions:
    build:
      context: .
      dockerfile: WSM/Dockerfile
    container_name: wsm_amount_filter_transactions
    environment:
      PYTHONUNBUFFERED: 1
      STATE_FILE_PATH: /app/output/worker_states_amount_filter_transactions.json
      HOST: 0.0.0.0
      PORT: 9011
    volumes:
    - ./output_wsm:/app/output
    networks:
    - coffee-net
  splitter_q1:
    build:
      context: .
      dockerfile: splitter/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
      wsm_splitter_q1:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: transactions_filtered_Q1_b
      COMPLETION_QUEUE: sorter_q1_v2_signal
      WSM_HOST: wsm_splitter_q1
      WSM_PORT: 9020
      CHUNK_SIZE: 1000
      BASE_TEMP_DIR: /app/temp/splitter_q1
    volumes:
    - ./splitter/temp:/app/temp
    networks:
    - coffee-net
  wsm_splitter_q1:
    build:
      context: .
      dockerfile: WSM/Dockerfile
    container_name: wsm_splitter_q1
    environment:
      PYTHONUNBUFFERED: 1
      STATE_FILE_PATH: /app/output/worker_states_splitter_q1.json
      HOST: 0.0.0.0
      PORT: 9020
    volumes:
    - ./output_wsm:/app/output
    networks:
    - coffee-net
  sorter_q1_v2:
    build:
      context: .
      dockerfile: sorter_v2/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      QUEUE_IN: sorter_q1_v2_signal
      COMPLETION_QUEUE: sender_q1_signal
      BASE_TEMP_DIR: /app/temp
      SORT_COLUMNS: '0'
    volumes:
    - ./splitter/temp:/app/temp
    - ./sorter_v2/temp:/app/temp
    - ./output:/app/output
    networks:
    - coffee-net
  grouper_q2_v2:
    build:
      context: .
      dockerfile: grouper_v2/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
      wsm_grouper_q2:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: transaction_items_filtered_Q2
      COMPLETION_QUEUE: reducer_q2_signal
      GROUPER_MODE: q2
      WSM_HOST: wsm_grouper_q2
      WSM_PORT: 9006
    volumes:
    - ./grouper_v2/temp/q2:/app/temp/grouper_v2_q2
    networks:
    - coffee-net
  wsm_grouper_q2:
    build:
      context: .
      dockerfile: WSM/Dockerfile
    container_name: wsm_grouper_q2
    environment:
      PYTHONUNBUFFERED: 1
      STATE_FILE_PATH: /app/output/worker_states_grouper_q2.json
      HOST: 0.0.0.0
      PORT: 9006
    volumes:
    - ./output_wsm:/app/output
    networks:
    - coffee-net
  reducer_q2:
    build:
      context: .
      dockerfile: reducer/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: reducer_q2_signal
      COMPLETION_QUEUE: topper_q2_signal
      REDUCER_MODE: q2
      INPUT_DIR: /app/temp/grouper_v2_q2
      OUTPUT_DIR: /app/reducer_temp/q2/transaction_items_filtered_Q2
    volumes:
    - ./grouper_v2/temp/q2:/app/temp/grouper_v2_q2
    - ./reducer/temp:/app/reducer_temp/q2
    networks:
    - coffee-net
  topper_q2:
    build:
      context: .
      dockerfile: topper/Dockerfile
    container_name: topper_q2
    depends_on:
      rabbitmq:
        condition: service_healthy
      grouper_q2_v2:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: topper_q2_signal
      INPUT_DIR: /app/reducer_temp/q2/transaction_items_filtered_Q2
      OUTPUT_FILE: /app/topper_temp/q2_top1.csv
      TOP_N: 1
      COMPLETION_QUEUE: sender_grouper_q2_signal
      TOPPER_MODE: Q2
    volumes:
    - ./reducer/temp:/app/reducer_temp/q2
    - ./topper/temp:/app/topper_temp
    networks:
    - coffee-net
  grouper_q3_v2:
    build:
      context: .
      dockerfile: grouper_v2/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
      wsm_grouper_q3:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: transactions_filtered_Q3
      COMPLETION_QUEUE: reducer_q3_signal
      GROUPER_MODE: q3
      WSM_HOST: wsm_grouper_q3
      WSM_PORT: 9007
    volumes:
    - ./grouper_v2/temp/q3:/app/temp/grouper_v2_q3
    networks:
    - coffee-net
  wsm_grouper_q3:
    build:
      context: .
      dockerfile: WSM/Dockerfile
    container_name: wsm_grouper_q3
    environment:
      PYTHONUNBUFFERED: 1
      STATE_FILE_PATH: /app/output/worker_states_grouper_q3.json
      HOST: 0.0.0.0
      PORT: 9007
    volumes:
    - ./output_wsm:/app/output
    networks:
    - coffee-net
  reducer_q3:
    build:
      context: .
      dockerfile: reducer/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: reducer_q3_signal
      COMPLETION_QUEUE: topper_q3_signal
      REDUCER_MODE: q3
      INPUT_DIR: /app/temp/grouper_v2_q3
      OUTPUT_DIR: /app/reducer_temp/q3/transactions_filtered_Q3
    volumes:
    - ./grouper_v2/temp/q3:/app/temp/grouper_v2_q3
    - ./reducer/temp:/app/reducer_temp/q3
    networks:
    - coffee-net
  topper_q3:
    build:
      context: .
      dockerfile: topper/Dockerfile
    container_name: topper_q3
    depends_on:
      rabbitmq:
        condition: service_healthy
      grouper_q3_v2:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: topper_q3_signal
      INPUT_DIR: /app/reducer_temp/q3/transactions_filtered_Q3
      OUTPUT_FILE: /app/topper_temp/q3_top1.csv
      TOP_N: 1
      COMPLETION_QUEUE: sender_grouper_q3_signal
      TOPPER_MODE: Q3
    volumes:
    - ./reducer/temp:/app/reducer_temp/q3
    - ./topper/temp:/app/topper_temp
    networks:
    - coffee-net
  grouper_q4_v2:
    build:
      context: .
      dockerfile: grouper_v2/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
      wsm_grouper_q4:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: transactions_cleaned_Q4
      COMPLETION_QUEUE: reducer_q4_signal
      GROUPER_MODE: q4
      WSM_HOST: wsm_grouper_q4
      WSM_PORT: 9008
    volumes:
    - ./grouper_v2/temp/q4:/app/temp/grouper_v2_q4
    networks:
    - coffee-net
  wsm_grouper_q4:
    build:
      context: .
      dockerfile: WSM/Dockerfile
    container_name: wsm_grouper_q4
    environment:
      PYTHONUNBUFFERED: 1
      STATE_FILE_PATH: /app/output/worker_states_grouper_q4.json
      HOST: 0.0.0.0
      PORT: 9008
    volumes:
    - ./output_wsm:/app/output
    networks:
    - coffee-net
  reducer_q4:
    build:
      context: .
      dockerfile: reducer/Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
      gateway:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: reducer_q4_signal
      COMPLETION_QUEUE: topper_q4_signal
      REDUCER_MODE: q4
      INPUT_DIR: /app/temp/grouper_v2_q4
      OUTPUT_DIR: /app/reducer_temp/q4/transactions_cleaned_Q4
    volumes:
    - ./grouper_v2/temp/q4:/app/temp/grouper_v2_q4
    - ./reducer/temp:/app/reducer_temp/q4
    networks:
    - coffee-net
  topper_q4:
    build:
      context: .
      dockerfile: topper/Dockerfile
    container_name: topper_q4
    depends_on:
      rabbitmq:
        condition: service_healthy
      grouper_q4_v2:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: topper_q4_signal
      INPUT_DIR: /app/reducer_temp/q4/transactions_cleaned_Q4
      OUTPUT_FILE: /app/topper_temp/q4_top3.csv
      TOP_N: 3
      COMPLETION_QUEUE: sender_grouper_q4_signal
      TOPPER_MODE: Q4
    volumes:
    - ./reducer/temp:/app/reducer_temp/q4
    - ./topper/temp:/app/topper_temp
    networks:
    - coffee-net
  sender_grouper_q4:
    build:
      context: .
      dockerfile: sender/Dockerfile
    container_name: sender_grouper_q4
    depends_on:
      rabbitmq:
        condition: service_healthy
      topper_q4:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: sender_grouper_q4_signal
      QUEUE_OUT: resultados_groupby_q4
      INPUT_FILE: /app/topper_temp/topper_q4_signal/q4_top.csv
      BATCH_SIZE: 5000
      QUERY_TYPE: q4
    volumes:
    - ./topper/temp:/app/topper_temp
    networks:
    - coffee-net
  joiner_q4:
    build:
      context: .
      dockerfile: joiner/Dockerfile
    container_name: joiner_q4
    depends_on:
      rabbitmq:
        condition: service_healthy
      cleaner_stores:
        condition: service_started
      cleaner_users:
        condition: service_started
      sender_grouper_q4:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      MULTIPLE_QUEUES: stores_cleaned_q4,resultados_groupby_q4,users_cleaned
      QUEUE_OUT: sort_q4_request
      OUTPUT_FILE: /app/output/q4_unsorted.csv
      QUERY_TYPE: q4
    volumes:
    - ./output:/app/output
    networks:
    - coffee-net
  joiner_q2:
    build:
      context: .
      dockerfile: joiner/Dockerfile
    container_name: joiner_q2
    depends_on:
      rabbitmq:
        condition: service_healthy
      cleaner_menu_items:
        condition: service_started
      sender_grouper_q2:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      MULTIPLE_QUEUES: resultados_groupby_q2,menu_items_cleaned
      QUEUE_OUT: sender_q2_a_signal, sender_q2_b_signal
      OUTPUT_FILE: /app/output/q2_a.csv, /app/output/q2_b.csv
      QUERY_TYPE: q2
    volumes:
    - ./output:/app/output
    networks:
    - coffee-net
  sorter_q4:
    build:
      context: .
      dockerfile: sort/Dockerfile
    container_name: sorter_q4
    depends_on:
      rabbitmq:
        condition: service_healthy
      joiner_q4:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: sort_q4_request
      INPUT_FILE: /app/output/q4_unsorted.csv
      OUTPUT_FILE: /app/output/q4.csv
      COMPLETION_QUEUE: sender_q4_signal
      DATA_TYPE: q4
    volumes:
    - ./output:/app/output
    networks:
    - coffee-net
  sender_q4:
    build:
      context: .
      dockerfile: sender/Dockerfile
    container_name: sender_q4
    depends_on:
      rabbitmq:
        condition: service_healthy
      sorter_q4:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: sender_q4_signal
      QUEUE_OUT: results
      INPUT_FILE: /app/output/q4.csv
      QUERY_TYPE: q4
      INCLUDE_HEADERS: true
    volumes:
    - ./output:/app/output
    networks:
    - coffee-net
  sender_q2_a:
    build:
      context: .
      dockerfile: sender/Dockerfile
    container_name: sender_q2_a
    depends_on:
      rabbitmq:
        condition: service_healthy
      joiner_q2:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: sender_q2_a_signal
      QUEUE_OUT: results
      INPUT_FILE: /app/output/q2_a.csv
      QUERY_TYPE: q2_a
      INCLUDE_HEADERS: true
    volumes:
    - ./output:/app/output
    networks:
    - coffee-net
  sender_q2_b:
    build:
      context: .
      dockerfile: sender/Dockerfile
    container_name: sender_q2_b
    depends_on:
      rabbitmq:
        condition: service_healthy
      joiner_q2:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: sender_q2_b_signal
      QUEUE_OUT: results
      INPUT_FILE: /app/output/q2_b.csv
      QUERY_TYPE: q2_b
      INCLUDE_HEADERS: true
    volumes:
    - ./output:/app/output
    networks:
    - coffee-net
  sender_grouper_q2:
    build:
      context: .
      dockerfile: sender/Dockerfile
    container_name: sender_grouper_q2
    depends_on:
      rabbitmq:
        condition: service_healthy
      topper_q2:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: sender_grouper_q2_signal
      QUEUE_OUT: resultados_groupby_q2
      INPUT_FILE: /app/topper_temp/topper_q2_signal/q2_top.csv
      BATCH_SIZE: 5000
      QUERY_TYPE: q2
    volumes:
    - ./topper/temp:/app/topper_temp
    networks:
    - coffee-net
  sender_grouper_q3:
    build:
      context: .
      dockerfile: sender/Dockerfile
    container_name: sender_grouper_q3
    depends_on:
      rabbitmq:
        condition: service_healthy
      topper_q3:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: sender_grouper_q3_signal
      QUEUE_OUT: resultados_groupby_q3
      INPUT_FILE: /app/topper_temp/topper_q3_signal/q3_top.csv
      BATCH_SIZE: 5000
      QUERY_TYPE: q3
    volumes:
    - ./topper/temp:/app/topper_temp
    networks:
    - coffee-net
  sender_q1:
    build:
      context: .
      dockerfile: sender/Dockerfile
    container_name: sender_q1
    depends_on:
      rabbitmq:
        condition: service_healthy
      sorter_q1_v2:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: sender_q1_signal
      QUEUE_OUT: results
      INPUT_FILE: /app/output/q1.csv
      QUERY_TYPE: q1
      INCLUDE_HEADERS: true
    volumes:
    - ./output:/app/output
    networks:
    - coffee-net
  joiner_q3:
    build:
      context: .
      dockerfile: joiner/Dockerfile
    container_name: joiner_q3
    depends_on:
      rabbitmq:
        condition: service_healthy
      cleaner_stores:
        condition: service_started
      sender_grouper_q3:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      MULTIPLE_QUEUES: resultados_groupby_q3,stores_cleaned_q3
      QUEUE_OUT: sort_q3_request
      OUTPUT_FILE: /app/output/q3_unsorted.csv
      QUERY_TYPE: q3
    volumes:
    - ./output:/app/output
    networks:
    - coffee-net
  sorter_q3:
    build:
      context: .
      dockerfile: sort/Dockerfile
    container_name: sorter_q3
    depends_on:
      rabbitmq:
        condition: service_healthy
      joiner_q3:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: sort_q3_request
      INPUT_FILE: /app/output/q3_unsorted.csv
      OUTPUT_FILE: /app/output/q3.csv
      COMPLETION_QUEUE: sender_q3_signal
      DATA_TYPE: q3
    volumes:
    - ./output:/app/output
    networks:
    - coffee-net
  sender_q3:
    build:
      context: .
      dockerfile: sender/Dockerfile
    container_name: sender_q3
    depends_on:
      rabbitmq:
        condition: service_healthy
      sorter_q3:
        condition: service_started
    environment:
      PYTHONUNBUFFERED: 1
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: admin
      RABBITMQ_PASS: secretpassword
      QUEUE_IN: sender_q3_signal
      QUEUE_OUT: results
      INPUT_FILE: /app/output/q3.csv
      QUERY_TYPE: q3
      INCLUDE_HEADERS: true
    volumes:
    - ./output:/app/output
    networks:
    - coffee-net
networks:
  coffee-net:
    driver: bridge
